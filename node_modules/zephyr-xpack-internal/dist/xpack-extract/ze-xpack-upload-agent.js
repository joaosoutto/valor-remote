"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.xpack_zephyr_agent = xpack_zephyr_agent;
const zephyr_agent_1 = require("zephyr-agent");
const build_webpack_assets_map_1 = require("../xpack-extract/build-webpack-assets-map");
const index_1 = require("../lifecycle-events/index");
const get_build_stats_1 = require("../federation-dashboard-legacy/get-build-stats");
async function xpack_zephyr_agent({ stats, stats_json, assets, pluginOptions, }) {
    (0, zephyr_agent_1.ze_log)('Initiating: Zephyr Webpack Upload Agent');
    const zeStart = Date.now();
    const { wait_for_index_html, zephyr_engine } = pluginOptions;
    try {
        const assetsMap = await (0, build_webpack_assets_map_1.buildWebpackAssetMap)(assets, {
            wait_for_index_html,
        });
        // webpack dash data
        const { EDGE_URL, PLATFORM, DELIMITER } = await zephyr_engine.application_configuration;
        const dashData = await (0, get_build_stats_1.getBuildStats)({
            stats,
            stats_json,
            assets,
            pluginOptions,
            EDGE_URL,
            PLATFORM,
            DELIMITER,
        });
        await zephyr_engine.upload_assets({
            assetsMap,
            mfConfig: pluginOptions.mfConfig,
            buildStats: dashData,
        });
    }
    catch (err) {
        (0, zephyr_agent_1.logFn)('error', zephyr_agent_1.ZephyrError.format(err));
    }
    finally {
        (0, index_1.emitDeploymentDone)();
        // todo: log end
        (0, zephyr_agent_1.ze_log)('Zephyr Webpack Upload Agent: Done in', Date.now() - zeStart, 'ms');
    }
}
//# sourceMappingURL=ze-xpack-upload-agent.js.map