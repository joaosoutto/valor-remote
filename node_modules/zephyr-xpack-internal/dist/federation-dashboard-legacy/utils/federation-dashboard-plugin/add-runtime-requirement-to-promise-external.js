"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.AddRuntimeRequirementToPromiseExternal = void 0;
class AddRuntimeRequirementToPromiseExternal {
    apply(compiler) {
        compiler.hooks.compilation.tap('AddRuntimeRequirementToPromiseExternal', (compilation) => {
            // TODO: access runtime global
            const { RuntimeGlobals } = compiler.webpack;
            // compilation.outputOptions.trustedTypes are used in browser environment to ensure XSS attack, this won't be useful in React Native
            // reference: https://github.com/web-infra-dev/rspack/blob/52d7dcd48df764674f50e65b51297a7a697c15e7/packages/rspack/src/config/types.ts#L306
            if (compilation.outputOptions.trustedTypes) {
                // This is for Webpack
                if (compilation.outputOptions.trustedTypes) {
                    compilation.hooks.additionalModuleRuntimeRequirements.tap('AddRuntimeRequirementToPromiseExternal', (module, set) => {
                        if (module.externalType === 'promise') {
                            set.add(RuntimeGlobals.loadScript);
                        }
                    });
                }
                // This is for Rspack (include Repack)
                compilation.hooks.additionalTreeRuntimeRequirements.tap('AddRuntimeRequirementToPromiseExternal', (chunk, set) => {
                    if (chunk.externalType === 'promise') {
                        set.add(RuntimeGlobals.loadScript);
                    }
                });
            }
            // even if `trustedTypes` don't exists, there isn't an external type, load the script anyways
            // TODO: verify if this works
            compilation.hooks.additionalTreeRuntimeRequirements.tap('AddRuntimeRequirementToPromiseExternal', (chunk, set) => {
                set.add(RuntimeGlobals.loadScript);
            });
        });
    }
}
exports.AddRuntimeRequirementToPromiseExternal = AddRuntimeRequirementToPromiseExternal;
//# sourceMappingURL=add-runtime-requirement-to-promise-external.js.map