"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.setupZeDeploy = setupZeDeploy;
const index_1 = require("../lifecycle-events/index");
const ze_xpack_upload_agent_1 = require("../xpack-extract/ze-xpack-upload-agent");
function setupZeDeploy(pluginOptions, compiler) {
    const { pluginName } = pluginOptions;
    compiler.hooks.thisCompilation.tap(pluginName, (compilation) => {
        compilation.hooks.processAssets.tapPromise({
            name: pluginName,
            stage: compiler.webpack.Compilation.PROCESS_ASSETS_STAGE_REPORT,
        }, async (assets) => {
            const stats = compilation.getStats();
            const stats_json = compilation.getStats().toJson();
            await pluginOptions.zephyr_engine.start_new_build();
            process.nextTick(ze_xpack_upload_agent_1.xpack_zephyr_agent, {
                stats,
                stats_json,
                assets,
                pluginOptions,
            });
            if (!pluginOptions.wait_for_index_html) {
                await (0, index_1.onDeploymentDone)();
            }
            // empty line to separate logs from other plugins
            console.log();
        });
    });
}
//# sourceMappingURL=ze-setup-ze-deploy.js.map